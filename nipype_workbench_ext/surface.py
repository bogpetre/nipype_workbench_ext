from nipype.interfaces.workbench import base as wb
from nipype.interfaces.base import (
    BaseInterface, 
    BaseInterfaceInputSpec, 
    traits, 
    File, 
    isdefined, 
    TraitedSpec, 
    CommandLineInputSpec, 
)
from traits.api import List
import os

class SurfaceVertexAreasInputSpec(CommandLineInputSpec):
    surface=File(
        argstr='%s',
        position=0,
        exists=True,
        desc="The surface to measure"
    )
    out_file=File(
        argstr='%s',
        position=1,
        genfile=True,
        desc="The output metric. Autogenerated if not specified."
    )

class SurfaceVertexAreasOutputSpec(TraitedSpec):
    out_file=File(
        exists=True,
        desc="The output metric file"
    )

class SurfaceVertexAreas(wb.WBCommand):
    input_spec = SurfaceVertexAreasInputSpec
    output_spec = SurfaceVertexAreasOutputSpec

    _cmd = 'wb_command -surface-vertex-areas'

    def _gen_filename(self, name):
        import os

        if name == 'out_file':
            if 'out_file' not in self.inputs.get() or not isdefined(self.inputs.out_file):
                return os.path.join(os.getcwd(), 'surface_areas.func.gii')
            return self.inputs.out_file

    def _list_outputs(self):
        outputs = self.output_spec().get()
        if 'out_file' not in outputs or not isdefined(outputs['out_file']):
            outputs['out_file'] = self._gen_filename('out_file')

        return outputs


class SurfaceDistortionInputSpec(CommandLineInputSpec):
    surface_reference=File(
        argstr='%s',
        position=0,
        exists=True,
        desc="the reference surface"
    )

    surface_distortion=File(
        argstr='%s',
        position=1,
        exists=True,
        desc="the distorted surface"
    )

    out_file=File(
        argstr='%s',
        position=2,
        genfile=True,
        desc="The output metric. Autogenerated if not specified."
    )

    smooth=traits.Float(
        argstr='-smooth %f',
        position=3,
        desc="the size of the smoothing kernel in mm, as sigma by default"
    )

    fwhm=traits.Bool(False,
        argstr='-fwhm',
        position=4,
        requires=['smooth'],
        desc="kernel size is FWHM, not sigma"
    )

    caret5_method=traits.Bool(False,
        argstr='-caret5-method',
        position=5,
        desc="use the surface distortion method from caret5"
    )

    edge_method=traits.Bool(False,
        argstr='-edge-method',
        position=6,
        desc="calculate distortion of edge lengths rather than areas"
    )

    local_affine_method=traits.Bool(False,
        argstr='-local-affine-method',
        position=7,
        desc="calculate distortion by the local affines between triangles"
    )

    log2=traits.Bool(False,
        argstr='-log2',
        position=8,
        desc="apply base-2 log transform"
    )


class SurfaceDistortionOutputSpec(TraitedSpec):
    out_file=File(
        exists=True,
        desc="The output metric file"
    )

class SurfaceDistortionAreas(wb.WBCommand):
    input_spec = SurfaceDistortionInputSpec
    output_spec = SurfaceDistortionOutputSpec

    _cmd = 'wb_command -surface-distortion'

    def _gen_filename(self, name):
        import os

        if name == 'out_file':
            if 'out_file' not in self.inputs.get() or not isdefined(self.inputs.out_file):
                return os.path.join(os.getcwd(), 'arealDistortion.func.gii')
            else:
                basename = os.path.basename(self.inputs.out_file)
                return os.path.join(os.getcwd(), basename)
            return self.inputs.out_file

    def _list_outputs(self):
        outputs = self.output_spec().get()
        if 'out_file' not in outputs or not isdefined(outputs['out_file']):
            outputs['out_file'] = self._gen_filename('out_file')

        return outputs